(function(){var pluginName="hg_h5app";var defaultOptions={triggerBtn:"",triggerEvent:"click",needSystemInfo:"",needUserInfo:"",needLocation:"",sharePlatsActionParam:"",goToMapParam:"",makeTelParam:"",appAuthTimeout:6e3,scrollElement:$(".page-content").length?$(".page-content"):$("body")};var H5App=function(options){$.my=this;this.op=$.extend({},defaultOptions,options);this.wificz=true;this.msg={callSystemInfo_error:"不能获取设备信息",callUserInfo_error:"不能获取用户信息",callLocation_error:"不能获取经纬度",sharePlatsAction_error:"暂不支持分享功能",goToMap_error:"暂不支持调地图功能",appALiPay_error:"暂不支持调支付宝功能",makeTel_error:"暂不支持打电话功能",goOutlink_error:"暂不支持去外链页"};this.init()};H5App.prototype={constructor:H5App,init:function(){var self=this,op=self.op;if(op.triggerBtn){if(typeof op.triggerBtn=="string"){op.triggerBtn=op.triggerBtn.split(" ")}}if(!!op.triggerEvent){self.bindEvent()}if(!!op.needSystemInfo){var duration=0;var intervalId=setInterval(function(){if(self.appSystemInfo){clearInterval(intervalId)}else{duration+=500;if(duration>=self.op.appAuthTimeout){clearInterval(intervalId);if(!self.appSystemInfo){self.wificz=false;console.log("刷新试试")}}}},500);self.callWebviewMethod("callSystemInfo","getSystemInfo")}if(!!op.needUserInfo){self.callWebviewMethod("callUserInfo","getUserInfo")}if(!!op.needLocation){self.callWebviewMethod("callLocation","getLocation")}},bindEvent:function(){var self=this,op=this.op;$.each(op.triggerBtn,function(kk,vv){if(/^\./.test(vv)){alert("类名不正确, 格式是 XXX");return false}var elem=$("."+vv);if(!elem.length){return}elem.on(op.triggerEvent,$.proxy(self.gainElemParam,self))})},gainElemParam:function(event){this.prevent(event);var obj=$(event.currentTarget),params,operation=obj.attr("data-operation");if(obj.data("param")){params=typeof obj.data("param")=="string"?JSON.parse(obj.data("param")):obj.data("param")}else{params=this.op[operation+"Param"]||""}if(operation=="goOutlink"){var type=obj.data("type")||"";this.callOutlink(type)}if(params){this.callneedParamMethod(operation,params)}else{this.callWebviewMethod(operation)}},callWebviewMethod:function(callfunc,backfunc){backfunc=backfunc||callfunc;var self=this,mbldevice=self.getMobileDevice();if(mbldevice=="Android"){try{window.android[callfunc]()}catch(e){$.isFunction(this.op.errorTip)&&this.op.errorTip(this.msg[callfunc+"_error"])}}else if(mbldevice=="iOS"){window.location.hash="";window.location.hash="#func="+backfunc}else if(backfunc!=callfunc){$.pcUlts[callfunc].call(self)}else{console.log("请到移动设备上测试")}},callneedParamMethod:function(callfunc,params){var mbldevice=this.getMobileDevice(),ios_sch="";$.each(params,function(kk,vv){vv=encodeURI(vv);ios_sch+="&"+kk+"="+vv});if(callfunc=="sharePlatsAction"){if(!this.wificz){var t=$("#tip-share");if(t.length>0){t.show()}else{t=$('<div id="tip-share" class="tip-share-wechat"><img src="//app.wifiwx.com/img/tip-share-wechat.png" width="100%" alt="分享提示" /></div>').css({position:"absolute",width:"100%",top:0,left:0,"z-index":101,"max-height":"170px"});this.op.scrollElement.append(t);t.click(function(){$(this).hide()})}return}}if(mbldevice=="Android"){try{switch(callfunc){case"sharePlatsAction":{window.android.sharePlatsAction(params.content,params.content_url,params.pic);break}case"goToMap":{window.android.goToMap(params.address,params.lat,params.lng,params.name);break}case"makeTel":{window.android.makeTel(params.tel);break}case"appALiPay":{window.android.appALiPay(params.order_id)}}}catch(e){$.isFunction(this.op.errorTip)&&this.op.errorTip(this.msg[callfunc+"_error"])}}else if(mbldevice=="iOS"){window.location.hash="";window.location.hash="#func="+callfunc+ios_sch}else{console.log(callfunc)}},callOutlink:function(type){var mbldevice=this.getMobileDevice();if(mbldevice=="Android"){try{window.android.goOutlink(type)}catch(e){$.isFunction(this.op.errorTip)&&this.op.errorTip(this.msg["goOutlink_error"])}}else if(mbldevice=="iOS"){type=type.replace("#","&");window.location.hash="";window.location.hash="#"+type}else{console.log(type)}},getSystemInfo:function(json){var self=$.my,op=self.op;self.appSystemInfo=json.device_token?json:json.deviceInfo;if(!!op.needSystemInfo&&$.isFunction(op.needSystemInfo)){op.needSystemInfo.call(this,json)}},getUserInfo:function(json){var self=$.my,op=self.op;if(!!op.needUserInfo&&$.isFunction(op.needUserInfo)){op.needUserInfo.call(this,json)}},getLocation:function(json){var self=$.my,op=self.op;if(!!op.needLocation&&$.isFunction(op.needLocation)){op.needLocation.call(this,json)}},getMobileDevice:function(){var mbldevice=navigator.userAgent.toLowerCase();if(/iphone|ipod|ipad/gi.test(mbldevice)){return"iOS"}else if(/android/gi.test(mbldevice)){return"Android"}else{return"Unknow Device"}},prevent:function(e){if(e){e.stopPropagation();e.preventDefault()}}};window.getSystemInfo=function(json){H5App.prototype.getSystemInfo.call(H5App.prototype,json)};window.getUserInfo=function(json){H5App.prototype.getUserInfo(json)};window.getLocation=function(json){H5App.prototype.getLocation(json)};$[pluginName]=function(option){return new H5App(option)}})();