<?php/* * 功能：支付宝主动通知调用的页面（服务器异步通知页面） 版本：2.0 日期：2011-09-01 '说明： * '以下代码只是为了方便商户测试而提供的样例代码，商户可以根据自己网站的需要，按照技术文档编写,并非一定要使用该代码。 * '该代码仅供学习和研究支付宝接口使用，只是提供一个参考。 */define('ROOT_DIR', '../../../../');define('CUR_CONF_PATH', './../../');require_once(ROOT_DIR.'global.php');require_once ("../../lib/paydata.class.php");require_once ("class/alipay_notify.php");//存在此次交易的缓存文件时，则调用，没有则去数据库查询$zhifubaojiaoyihao = $_POST['trade_no'];if (file_exists("config/".$zhifubaojiaoyihao."_cache_code.php")) {	include_once ("config/".$zhifubaojiaoyihao."_cache_code.php");}else{	$data_back = array();	$out = new paydataClass();	$data_back = $out->detail_back($zhifubaojiaoyihao);	$partner = $data_back['partner'];	$key = $data_back['key'];	$sec_id = $data_back['sec_id'];	$_input_charset = $data_back['_input_charset'];	}$alipay = new alipay_notify ( $partner, $key, $sec_id, $_input_charset ); // 构造通知函数信息$verify_result = $alipay->notify_verify (); // 计算得出通知验证结果if ($verify_result) {		$status = getDataForXML ( $_POST ['notify_data'], '/notify/trade_status' ); // 返回token	if ($status == 'TRADE_FINISHED') { 		// 交易成功结束		$mydingdan = $_POST['out_trade_no']; // 外部交易号		$myresult = "success"; // 订单状态，是否成功		$mytrade_no = $_POST['trade_no']; // 交易号		$buyer_email = $_POST['buyer_email']; //买家支付宝帐号		$total_fee = $_POST['total_fee']; //交易金额				$data = array();		$data['out_trade_no'] = $mydingdan;		$data['trade_no'] = $mytrade_no;		$data['trade_status'] = $myresult;		$data['buyer_email'] = $buyer_email;		$data['total_fee'] = $total_fee;				$out = new paydataClass();		$result = $out->detail($mydingdan);		if(is_array($result) &&!empty($result) && count($result)>0)		{			$data['update_time'] = TIMENOW;			$out->update($data,$result['id']);		}		else		{			$data['create_time'] = TIMENOW;			$data['update_time'] = TIMENOW;			$out->create($data);		}				echo "success"; // 请不要修改或删除，在判断交易正常后，必须在页面输出success		log_result ( "success" );	} else {		echo "fail";	}} else {	echo "fail";}?>