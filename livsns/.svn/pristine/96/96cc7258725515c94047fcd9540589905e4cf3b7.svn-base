<?php/**************************************************************************** LivSNS 0.1* (C)2004-2010 HOGE Software.** $Id: comment.php 7586 2013-07-05 09:40:56Z yaojian $***************************************************************************/require_once './global.php';include_once CUR_CONF_PATH . 'lib/comment.class.php';include_once CUR_CONF_PATH . 'lib/albums_app.class.php';define('MOD_UNIQUEID', 'comment');  //模块标识class commentApi extends appCommonFrm{	private $api;		public function __construct()	{		parent::__construct();		$this->api = new comment();	}	public function __destruct()	{		parent::__destruct();		unset($this->api);	}		/**	 * 获取评论数据	 */	public function show()	{		if ($this->user['group_type'] > MAX_ADMIN_TYPE)		{			//权限验证			$this->verify_content_prms();		}		$offset = isset($this->input['offset']) ? intval($this->input['offset']) : 0;		$count = isset($this->input['count']) ? intval($this->input['count']) : 20;		$condition = $this->filter_data();		$data = array(			'offset' => $offset,			'count' => $count,			'condition' => $condition		);		$comment_info = $this->api->show($data);		$this->setXmlNode('comment_info', 'comment');		if ($comment_info)		{			foreach ($comment_info as $comment)			{				$this->addItem($comment);			}		}		$this->output();	}		/**	 * 相册下的评论	 */	public function albums_comment()	{		if ($this->user['group_type'] > MAX_ADMIN_TYPE)		{			//权限验证			$this->verify_content_prms(array('_action' => 'show'));		}		$offset = isset($this->input['offset']) ? intval($this->input['offset']) : 0;		$count = isset($this->input['count']) ? intval($this->input['count']) : 20;		$condition = $this->filter_data();		$data = array(			'offset' => $offset,			'count' => $count,			'condition' => $condition		);		$comment_info = $this->api->show($data);		$albums_info = $this->api->detail('albums', array('id' => $condition['albums_id']));		//获取用户信息		$member_info = $this->getMemberInfo($albums_info['user_id']);		if ($member_info[$albums_info['user_id']])		{		    $albums_info['user'] = $member_info[$albums_info['user_id']];		}		$albums_info['albums_cover'] = unserialize($albums_info['albums_cover']);		$albums_info['comment'] = $comment_info;		$this->addItem($albums_info);		$this->output();	}		/**	 * 照片的评论	 */	public function photos_comment()	{		if ($this->user['group_type'] > MAX_ADMIN_TYPE)		{			//权限验证			$this->verify_content_prms(array('_action' => 'show'));		}		$offset = isset($this->input['offset']) ? intval($this->input['offset']) : 0;		$count = isset($this->input['count']) ? intval($this->input['count']) : 20;		$condition = $this->filter_data();		$data = array(			'offset' => $offset,			'count' => $count,			'condition' => $condition		);		$comment_info = $this->api->show($data);		$photo_info = $this->api->detail('photos', array('id' => $condition['photo_id']));		//获取用户信息		$member_info = $this->getMemberInfo($photo_info['user_id']);		if ($member_info[$photo_info['user_id']])		{		    $photo_info['user'] = $member_info[$photo_info['user_id']];		}		$photo_info['photos_info'] = unserialize($photo_info['photos_info']);		$photo_info['comment'] = $comment_info;		$this->addItem($photo_info);		$this->output();	}		/**	 * 获取评论总数	 */	public function count()	{		$condition = $this->filter_data();		$info = $this->api->count($condition);		echo json_encode($info);	}		/**	 * 获取单个评论数据	 */	public function detail()	{		if ($this->user['group_type'] > MAX_ADMIN_TYPE)		{			//权限验证			$this->verify_content_prms(array('_action' => 'show'));		}		$id = intval($this->input['id']);		if ($id <= 0) $this->errorOutput(PARAM_WRONG);		$comment_info = $this->api->detail('comment', array('id' => $id));		$this->addItem($comment_info);		$this->output();	}		/**	 * 审核评论操作	 */	public function audit()	{		$id = trim(urldecode($this->input['id']));		$id_arr = explode(',', $id);		$ids = array_filter($id_arr, 'filter_arr');		$id = implode(',', $ids);		if (empty($id)) $this->errorOutput(PARAM_WRONG);		//查询未审核		$back_info = $this->api->show(array(			'count' => -1,			'condition' => array(				'state' => 2,				'id' => $id			)		));		if ($back_info)		{			$albums_id = $albums = $photos = $back_id = array();			foreach ($back_info as $v)			{				$back_id[$v['id']] = $v['id'];				$albums[$v['albums_id']][] = $v['id'];				$photos[$v['photo_id']][] = $v['id'];				$albums_id[$v['albums_id']] = $v['albums_id'];			}			//权限验证			if ($this->user['group_type'] > MAX_ADMIN_TYPE)			{				$albums_id = implode(',', $albums_id);				$this->verify_prms($albums_id, 'audit');			}			$back_id = implode(',', $back_id);			$result = $this->api->update('comment', array('state' => 1), array('id' => $back_id));			//更新数据			foreach ($photos as $k => $v)			{				$this->api->update('photos', array('comment_num' => count($v)), array('id' => $k), true);			}			foreach ($albums as $k => $v)			{	        	$this->api->update('albums', array('comment_num' => count($v)), array('id' => $k), true);			}			$this->addItem($result);		}		$this->output();	}		//计划任务审核	public function planAudit()	{		$start_time = intval($this->input['start_time']);		$end_time = intval($this->input['end_time']);		$status = intval($this->input['status']);		$state = '';		if ($start_time && $end_time && $status)		{			switch ($status)			{				case 1:$state = 0;break;				case 2:$state = 1;break;				case 3:$state = 0;break;			}			$back_info = $this->api->show(array(				'count' => -1,				'condition' => array(					'state' => 2,					'isbanword' => 2,					'start_time' => $start_time,					'end_time' => $end_time				)			));			if ($back_info && $state)			{				$albums = $photos = $back_id = array();				foreach ($back_info as $v)				{					$back_id[$v['id']] = $v['id'];					$albums[$v['albums_id']][] = $v['id'];					$photos[$v['photo_id']][] = $v['id'];				}				$back_id = implode(',', $back_id);				$this->api->update('comment', array('state' => $state), array('id' => $back_id));				//更新数据				foreach ($photos as $k => $v)				{					$this->api->update('photos', array('comment_num' => count($v)), array('id' => $k), true);				}				foreach ($albums as $k => $v)				{		        	$this->api->update('albums', array('comment_num' => count($v)), array('id' => $k), true);				}			}		}		$this->addItem(true);		$this->output();	}		/**	 * 删除评论数据	 */	public function delete()	{		if ($this->user['group_type'] > MAX_ADMIN_TYPE)		{			//权限验证			$this->verify_content_prms();		}		$id = trim(urldecode($this->input['id']));		$id_arr = explode(',', $id);		$ids = array_filter($id_arr, 'filter_arr');		$id = implode(',', $ids);		if (empty($id)) $this->errorOutput(PARAM_WRONG);		$info = $this->api->show(array(			'count' => -1,			'condition' => array(				'id' => $id			)		));		if (!$info) $this->errorOutput(OBJECT_NULL);		$albums_id = $total_num = $albums = $photos = array();		foreach ($info as $v)		{			$albums_id[$v['albums_id']] = $v['albums_id'];			$total_num['albums'][$v['albums_id']][] = $v['id'];			$total_num['photos'][$v['photo_id']][] = $v['id'];			if ($v['state'] == 1)			{				$albums[$v['albums_id']][] = $v['id'];				$photos[$v['photo_id']][] = $v['id'];			}		}		//权限验证		if ($this->user['group_type'] > MAX_ADMIN_TYPE)		{			$albums_id = implode(',', $albums_id);			$this->verify_prms($albums_id, 'delete');		}		$result = $this->api->update('comment', array('isdrop' => 1), array('id' => $id));		//更新数据		if ($photos)		{			foreach ($photos as $k => $v)			{				$this->api->update('photos', array('comment_num' => -count($v)), array('id' => $k), true);			}		}		if ($albums)		{			foreach ($albums as $k => $v)			{	        	$this->api->update('albums', array('comment_num' => -count($v)), array('id' => $k), true);			}		}		if ($total_num['photos'])		{			foreach ($total_num['photos'] as $k => $v)			{				$this->api->update('photos', array('comment_total' => -count($v)), array('id' => $k), true);			}		}		if ($total_num['albums'])		{			foreach ($total_num['albums'] as $k => $v)			{	        	$this->api->update('albums', array('comment_total' => -count($v)), array('id' => $k), true);			}		}		$this->addItem($result);		$this->output();	}		//权限验证	private function verify_prms($albums_id, $_action = '')	{		$albumsApi = new albums_app();		$albums_info = $albumsApi->show(array('count' => -1, 'condition' => array('id' => $albums_id)));		$cate_id = array();		if ($albums_info)		{			foreach ($albums_info as $v)			{				if ($v['cate_id']) $cate_id[$v['cate_id']][] = $v['id'];			}		}		$sort_id = implode(',', $cate_id);		if ($sort_id)		{			$category_info = $albumsApi->get_category($sort_id);			$sort_ids = array();			if ($category_info)			{				foreach ($category_info as $v)				{					$sort_ids[$v['id']] = $v['parents'];				}			}			foreach ($albums_info as $v)			{				if ($v['cate_id'])				{					$v['nodes'][$v['cate_id']] = $sort_ids[$v['cate_id']];				}				if ($_action) $v['_action'] = $_action;				$this->verify_content_prms($v);			}		}		else		{			if ($_action) $this->verify_content_prms(array('_action' => $_action));		}	}		/**	 * 过滤查询数据	 */	private function filter_data()	{		$name = isset($this->input['k']) ? trim(urldecode($this->input['k'])) : '';		$time = isset($this->input['date_search']) ? intval($this->input['date_search']) : '';		$start_time = trim($this->input['start_time']);		$end_time = trim($this->input['end_time']);		$state = isset($this->input['status']) ? intval($this->input['status']) : '';		$albums_id = isset($this->input['albums_id']) ? intval($this->input['albums_id']) : 0;		$photo_id = isset($this->input['photo_id']) ? intval($this->input['photo_id']) : 0;		$cate_id = intval($this->input['_id']);		$data = array(			'keyword' => $name,			'date_search' => $time,			'start_time' => $start_time,			'end_time' => $end_time,			'state' => $state,			'albums_id' => $albums_id,			'photo_id' => $photo_id		);		//非管理员判断权限		if ($this->user['group_type'] > MAX_ADMIN_TYPE)		{			if ($authnode = $this->user['prms']['app_prms'][APP_UNIQUEID]['nodes'])			{				$albumsApi = new albums_app();				$authnode_str = $authnode ? implode(',', $authnode) : '';				if ($authnode_str === '0')				{					$cate_id = $authnode_str;				}				if ($authnode_str)				{					$authnode_str = $cate_id ? $authnode_str .',' . $cate_id : $authnode_str;					$info = $albumsApi->get_category($authnode_str);					$authnode_array = array();					foreach ($info as $v)					{						$authnode_array[$v['id']] = explode(',', $v['childs']);					}					$authnode_str = '';					foreach ($authnode_array as $node_id => $n)					{						if ($node_id == $cate_id)						{							$node_father_array = $n;							if (!in_array($cate_id, $authnode)) continue;						}						$authnode_str .= implode(',', $n) . ',';					}					$authnode_str = true ? $authnode_str . '0' : trim($authnode_str, ',');					if (!$cate_id)					{						$cate_id = $authnode_str;					}					else					{						$authnode_array = explode(',', $authnode_str);						if (!in_array($cate_id, $authnode_array))						{							if (!$auth_child_node_array = array_intersect($node_father_array, $authnode_array))							{								$this->errorOutput(NO_PRIVILEGE);							}							$cate_id = implode(',', $auth_child_node_array);						}					}				}								$albums_info = $albumsApi->show(array('count' => -1, 'condition' => array('cate_id' => $cate_id)));				if ($albums_info && (!$albums_id && !$photo_id))				{					$albums_id = array();					foreach ($albums_info as $v)					{						$albums_id[$v['id']] = $v['id'];					}					$data['albums_id'] = implode(',', $albums_id);				}			}		}		return $data;	}		/**	 * 获取会员信息	 * @param Int|String $user_id	 */	private function getMemberInfo($user_id)	{	    if ($this->input['latest'])	    {	        //新会员	        include_once ROOT_PATH . 'lib/class/members.class.php';    		$newMember = new members();    		$member_info = $newMember->get_members($user_id);    		if ($member_info)    		{    		    $memberInfo = array();    		    foreach ($member_info as $v)    		    {    		        $memberInfo[$v['member_id']]['id'] = $v['member_id'];    		        $memberInfo[$v['member_id']]['nick_name'] = $v['member_name'];    		        $memberInfo[$v['member_id']]['avatar'] = $v['avatar'];    		    }    		}	    }	    else	    {	        include_once ROOT_PATH . 'lib/class/member.class.php';    		$member = new member();    		$member_info = $member->getMemberById($user_id);    		$member_info = $member_info[0];    		if ($member_info)    		{    		    $memberInfo = array();    		    foreach ($member_info as $k => $v)    		    {    		        $memberInfo[$k]['id'] = $v['id'];    		        $memberInfo[$k]['nick_name'] = $v['nick_name'];    		        $memberInfo[$k]['avatar'] = $v['avatar'];    		    }    		}	    }	    return $memberInfo;	}}function filter_arr(&$value){	$value = intval($value);	return $value <= 0 ? false : true;}$out = new commentApi();$action = $_INPUT['a'];if (!method_exists($out,$action)){	$action = 'show';}$out->$action();?>