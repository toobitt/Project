<?phpclass cardClass extends InitFrm{	public function __construct()	{		parent::__construct();	}		public function __destruct()	{		parent::__destruct();	}		//m2o 后台show	public function show($offset, $count, $data)	{		if ($count != -1)		{			$data_limit = ' LIMIT ' . $offset . ' , ' . $count;		}		$sql = 'SELECT * FROM ' . DB_PREFIX . 'card WHERE active = 1 ';				if ($data && is_array($data))		{			$condition = $this->get_condition($data);		}		elseif ($data && is_string($data))		{			$condition = $data;		}		if ($condition) $sql .= $condition;		$paixu = " order by is_on desc,order_id desc,id desc ";		$sql .= $paixu;		if ($data_limit) $sql .= $data_limit;		$query = $this->db->query($sql);		$info = array();		while ($rows = $this->db->fetch_array($query))		{			$info[] = $rows;		}		return $info;	}		//输出移动端	public function show_card($limit='')	{		$info = array();		$sql = 'SELECT * FROM ' . DB_PREFIX . 'card WHERE active = 1 and is_on = 1 and status = 2 ';		$paixu = " order by order_id desc,id desc  ".$limit;		$sql .= $paixu;		$query = $this->db->query($sql);		$pregreplace = array(' ', '<!--', '-->', '>', '<', '"', '!', "'", "\n", '$', "\r");                $pregfind = array('&#032;', '&#60;&#33;--', '--&#62;', '&gt;', '&lt;', '&quot;', '&#33;', '&#39;', "\n", '&#036;', '');		while ($rows = $this->db->fetch_array($query))		{			$rows['content'] = unserialize($rows['content']);                        if(is_array($rows['content']))                        {                            foreach($rows['content'] as $k=>$v)                            {                                $rows['content'][$k]['title'] = str_replace($pregfind, $pregreplace, $rows['content'][$k]['title']);                            }                        }			$info[] = $rows;		}				$i = count($info);				//异常数据的输出		$sql_un = 'SELECT b.id,b.title,b.is_title,b.is_html,b.htmltext,b.htmlwidth,b.htmlheight,b.validtime,b.content,b.order_id,b.contentnumber,b.update_time FROM ' . DB_PREFIX . 'card  as a, '. DB_PREFIX . 'card_unusually as b  WHERE a.is_on = 1 and a.active = 1 and a.id = b.id and a.is_unusually = 2 ';		$paixu_un = " order by b.order_id asc  ";		$sql_un .= $paixu_un;		$query_un = $this->db->query($sql_un);		while ($rows_un = $this->db->fetch_array($query_un))		{			$rows_un['content'] = unserialize($rows_un['content']);			$info[$i] = $rows_un;			$i=$i+1;		}				return $info;	}		/*	 * * 卡片上新闻的列表	 */	public function shownewslist($id)	{		$sql = 'SELECT * FROM ' . DB_PREFIX . 'card_content WHERE active = 1 and cardid = '.$id;		$paixu = " order by order_id asc,id desc ";		$sql .= $paixu;		$query = $this->db->query($sql);		$info = array();		while ($rows = $this->db->fetch_array($query))		{			$rows['create_time'] = date('Y-m-d H:i:s',$rows['create_time']);			$info[] = $rows;		}		return $info;	}		/*	 * * 卡片上新闻的样式	 */	public function showcss()	{		$sql = 'SELECT * FROM ' . DB_PREFIX . 'card_content_css WHERE active = 1 ';		$paixu = " order by order_id asc ";		$sql .= $paixu;		$query = $this->db->query($sql);		$info = array();		while ($rows = $this->db->fetch_array($query))		{			$info[] = $rows;		}		return $info;	}		//根据关键字查询总数	public function count($data)	{		$sql = 'SELECT COUNT(id) AS total FROM ' . DB_PREFIX . 'card WHERE active = 1';		$condition = $this->get_condition($data);		$sql .= $condition;		return $this->db->query_first($sql);	}		//信息读取 $id	public function detail($id)	{		$sql = 'SELECT * FROM ' . DB_PREFIX . 'card WHERE active = 1 and id = ' . $id;		return $this->db->query_first($sql);	}		//基本信息添加操作	public function create($data)	{		$fields = array();		foreach($data as $k=>$v)		{			if (is_string($v))			{				$fields[] = $k . "='" . $v . "'";			}			elseif (is_int($v))			{				$fields[] = $k . '=' . $v;			}		}		$sql = 'INSERT INTO ' . DB_PREFIX . 'card SET ' . implode(',', $fields);		$this->db->query($sql);		$data['id'] = $this->db->insert_id();		if ($data['id'])		{			return $data;		}		return false;	}			//基本信息添加操作	public function create_content($data)	{		$fields = array();		foreach($data as $k=>$v)		{			if (is_string($v))			{				$fields[] = $k . "='" . $v . "'";			}			elseif (is_int($v))			{				$fields[] = $k . '=' . $v;			}		}		$sql = 'INSERT INTO ' . DB_PREFIX . 'card_content SET ' . implode(',', $fields);		$this->db->query($sql);		$data['id'] = $this->db->insert_id();		if ($data['id'])		{			return $data;		}		return $data;	}			//更新基本信息	public function update($data, $id)	{		$fields = array();		foreach($data as $k=>$v)		{			if (is_string($v))			{				$fields[] = $k . "='" . $v . "'";			}			elseif (is_int($v))			{				$fields[] = $k . '=' . $v;			}		}		$sql = 'UPDATE ' . DB_PREFIX . 'card SET ' . implode(',', $fields) . ' WHERE 1';		if (is_int($id))		{			$sql .= ' AND id = ' . $id;		}		elseif (is_string($id))		{			$sql .= ' AND id in (' . $id . ')';		}		$this->db->query($sql);		return $data;	}		//更新基本信息	public function update_content($data, $id)	{		$fields = array();		foreach($data as $k=>$v)		{			if (is_string($v))			{				$fields[] = $k . "='" . $v . "'";			}			elseif (is_int($v))			{				$fields[] = $k . '=' . $v;			}		}		$sql = 'UPDATE ' . DB_PREFIX . 'card_content SET ' . implode(',', $fields) . ' WHERE 1';		if (is_int($id))		{			$sql .= ' AND id = ' . $id;		}		elseif (is_string($id))		{			$sql .= ' AND id in (' . $id . ')';		}		$this->db->query($sql);		return $data;	}			public function delete($id)	{		$sql = 'UPDATE ' . DB_PREFIX . 'card SET active = 0 WHERE 1';		if (is_int($id))		{			$sql .= ' AND id = ' . $id;		}		elseif (is_string($id))		{			$sql .= ' AND id in (' . $id . ')';		}		return $this->db->query($sql);	}		public function display($id,$is_on)	{		$sql = 'UPDATE ' . DB_PREFIX . 'card SET is_on = '.$is_on.' WHERE id = '.$id.' ';		return $this->db->query($sql);	}		//删除卡片内容表 cardid标示的内容 	public function delete_all($cardid,$id)	{		$sql = 'delete from ' . DB_PREFIX . 'card_content WHERE  cardid = '.$cardid.' ';		if (is_int($id))		{			$sql .= ' AND id != ' . $id;		}		elseif (is_string($id))		{			$sql .= ' AND id not in (' . $id . ')';		}		return $this->db->query($sql);	}	public function audit($id,$status)	{		$id = intval($id);		$status = intval($status);		if($status==1)		{			$status = 2;		}		elseif($status==2)		{			$status = 3;		}		elseif($status==3)		{			$status = 2;		}				if($status==2)		{			//如果状态为已审核，那么创建冗余内容,并且清除异常			$sql_content = 'SELECT * FROM ' . DB_PREFIX . 'card_content WHERE active = 1 and cardid = '.$id.' order by order_id asc,id desc  ';			$query_content = $this->db->query($sql_content);			$info_content = array();			while ($rows_content = $this->db->fetch_array($query_content))			{				if($rows_content['indexpic']!="")				{					$rows_content['indexpic'] = unserialize($rows_content['indexpic']);				}				if($rows_content['childs_data']!="")				{					$rows_content['childs_data'] = unserialize($rows_content['childs_data']);				}								$info_content[] = $rows_content;			}			//冗余数据			$content = serialize($info_content);			$update_time = TIMENOW;			$sql = 'update '.DB_PREFIX.'card set status = '.$status.' , is_unusually = 1 , content = \''.$content.'\',update_time = '.$update_time.' where id = ' . $id;			$this->db->query($sql);			//清除异常纪录			$sql_un = 'delete from '.DB_PREFIX.'card_unusually where id = '.$id.' ';			$this->db->query($sql_un);			unset($info_content);			unset($rows_content);		}		else {			//如果状态从"已审核"到"已打回" 创建异常			//创建异常纪录			$sql_con = 'SELECT id,title,is_title,is_html,htmltext,htmlwidth,htmlheight,validtime,content,order_id,contentnumber FROM ' . DB_PREFIX . 'card WHERE active = 1 and id = ' . $id;			$result_con = $this->db->query_first($sql_con);			$fields = array();			$result_con['update_time'] = TIMENOW;			foreach($result_con as $k=>$v)			{				if (is_string($v))				{					$fields[] = $k . "='" . $v . "'";				}				elseif (is_int($v))				{					$fields[] = $k . '=' . $v;				}			}			$sql_un = 'INSERT INTO ' . DB_PREFIX . 'card_unusually SET ' . implode(',', $fields);			$this->db->query($sql_un);			//更新主表			$update_time = TIMENOW;			$sql = 'update '.DB_PREFIX.'card set status = '.$status.' , is_unusually = 2 , content = "",update_time = '.$update_time.'  where  id = ' . $id;			$this->db->query($sql);						unset($result_con);			unset($fields);		}				//ajax返回数组		$result = array();		$result['id'] = $id;		$result['status'] = $status;		return $result;	}		//新增异常表数据	public function create_un($id)	{		$sql_con = 'SELECT id,title,is_title,is_html,htmltext,htmltext,htmlwidth,validtime,content,order_id,contentnumber FROM ' . DB_PREFIX . 'card WHERE active = 1 and id = ' . $id;		$result_con = $this->db->query_first($sql_con);		$result_con['update_time'] = TIMENOW;		$fields = array();		foreach($result_con as $k=>$v)		{			if (is_string($v))			{				$fields[] = $k . "='" . $v . "'";			}			elseif (is_int($v))			{				$fields[] = $k . '=' . $v;			}		}		$sql_un = 'INSERT INTO ' . DB_PREFIX . 'card_unusually SET ' . implode(',', $fields);		return $this->db->query($sql_un);	}				public function emptyData($table)	{		$sql = 'TRUNCATE ' . DB_PREFIX . $table;		return $this->db->query($sql);	}		public function get_condition($data)	{		$condition = '';				//查询的关键字		if(isset($data['key']))		{			$keyword = htmlspecialchars(trim(urldecode($data['key'])));			$condition .= " AND title LIKE '%" . $keyword . "%' ";		}		return $condition;	}}?>